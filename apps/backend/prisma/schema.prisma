// ─── Prisma Schema ─── StarkDCA Backend ─────────────────────────────
// PostgreSQL with full relational integrity, indexes, and enums.

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────

enum PlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum Interval {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ExecutionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum UserRole {
  USER
  ADMIN
}

enum OAuthProvider {
  GOOGLE
}

// ─── Models ──────────────────────────────────────────────────────────

model User {
  id                   String   @id @default(uuid())
  starknetAddress      String?  @unique @map("starknet_address")
  name                 String?
  email                String?  @unique
  passwordHash         String?  @map("password_hash")
  role                 UserRole @default(USER)
  emailVerified        Boolean  @default(false) @map("email_verified")
  launchAccessGranted  Boolean  @default(false) @map("launch_access_granted")
  waitlistPosition     Int?     @map("waitlist_position")
  launchEmailSent      Boolean  @default(false) @map("launch_email_sent")
  nonce                Int      @default(0)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  plans         DCAPlan[]
  refreshTokens RefreshToken[]
  oauthAccounts OAuthAccount[]
  adminActions  AdminActionLog[] @relation("AdminActions")

  @@index([starknetAddress])
  @@index([email])
  @@index([launchAccessGranted])
  @@map("users")
}

model DCAPlan {
  id                    String     @id @default(uuid())
  userId                String     @map("user_id")
  depositTokenAddress   String     @map("deposit_token_address")
  targetTokenAddress    String     @map("target_token_address")
  amountPerExecution    String     @map("amount_per_execution")
  totalDeposited        String     @map("total_deposited")
  totalExecutions       Int        @map("total_executions")
  executionsCompleted   Int        @default(0) @map("executions_completed")
  interval              Interval
  nextExecutionAt       DateTime   @map("next_execution_at")
  status                PlanStatus @default(ACTIVE)
  onChainPlanId         String?    @map("on_chain_plan_id")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions ExecutionHistory[]

  @@index([userId])
  @@index([status, nextExecutionAt])
  @@index([onChainPlanId])
  @@map("dca_plans")
}

model ExecutionHistory {
  id               String          @id @default(uuid())
  planId           String          @map("plan_id")
  executionNumber  Int             @map("execution_number")
  amountIn         String          @map("amount_in")
  amountOut        String?         @map("amount_out")
  priceAtExecution Float?          @map("price_at_execution")
  txHash           String?         @map("tx_hash")
  status           ExecutionStatus @default(PENDING)
  errorMessage     String?         @map("error_message")
  executedAt       DateTime        @default(now()) @map("executed_at")
  createdAt        DateTime        @default(now()) @map("created_at")

  plan DCAPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, executionNumber])
  @@index([planId])
  @@index([status])
  @@index([executedAt])
  @@map("execution_history")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ─── OAuth Accounts ─────────────────────────────────────────────────
model OAuthAccount {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  provider       OAuthProvider
  providerUserId String        @map("provider_user_id")
  accessToken    String?       @map("access_token")
  refreshToken   String?       @map("refresh_token")
  tokenExpiresAt DateTime?     @map("token_expires_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

// ─── Waitlist ───────────────────────────────────────────────────────
model WaitlistUser {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  ipAddress String?  @map("ip_address")
  source    String?  // e.g., "landing", "referral", "twitter"
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([createdAt])
  @@map("waitlist_users")
}

// ─── Admin Action Log ─────────────────────────────────────────────
model AdminActionLog {
  id          String   @id @default(uuid())
  adminId     String   @map("admin_id")
  actionType  String   @map("action_type") // e.g., "suspend_user", "send_email", "launch_platform"
  targetId    String?  @map("target_id")   // e.g., userId, planId
  metadata    Json?    // Additional context (e.g., email subject, plan details)
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  admin User @relation("AdminActions", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([actionType])
  @@index([createdAt])
  @@map("admin_action_logs")
}
